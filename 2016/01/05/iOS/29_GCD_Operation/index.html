<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS翻译-你真的了解并发吗? | 小木头</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="翻译了一篇appcoda的文章，通俗易懂，理清了并发的相关知识点。
为了防止被墙，已把图片和demo下载的连接全部改成国内存储。
原文链接: http://www.appcoda.com/ios-concurrency/">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS翻译-你真的了解并发吗?">
<meta property="og:url" content="http://www.liuchendi.com/2016/01/05/iOS/29_GCD_Operation/index.html">
<meta property="og:site_name" content="小木头">
<meta property="og:description" content="翻译了一篇appcoda的文章，通俗易懂，理清了并发的相关知识点。
为了防止被墙，已把图片和demo下载的连接全部改成国内存储。
原文链接: http://www.appcoda.com/ios-concurrency/">
<meta property="og:image" content="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_1.jpg">
<meta property="og:image" content="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_2.jpg">
<meta property="og:image" content="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_3.png">
<meta property="og:image" content="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_4.png">
<meta property="og:image" content="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_5.png">
<meta property="og:image" content="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_6.png">
<meta property="og:updated_time" content="2016-01-05T11:39:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS翻译-你真的了解并发吗?">
<meta name="twitter:description" content="翻译了一篇appcoda的文章，通俗易懂，理清了并发的相关知识点。
为了防止被墙，已把图片和demo下载的连接全部改成国内存储。
原文链接: http://www.appcoda.com/ios-concurrency/">
  
    <link rel="alternative" href="/atom.xml" title="小木头" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7i7ht3.com1.z0.glb.clouddn.com/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">小木头</a></h1>
		</hgroup>

		
		<p class="header-subtitle">心中无敌则无敌于天下</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/about">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/lcddhr" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/329096966" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="http://lcddhr.github.io/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Core-Graphics/" style="font-size: 10px;">Core Graphics</a> <a href="/tags/GCD/" style="font-size: 10px;">GCD</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/NSLock、OSSpinLock、多线程同步、锁/" style="font-size: 10px;">NSLock、OSSpinLock、多线程同步、锁</a> <a href="/tags/NSOperation/" style="font-size: 10px;">NSOperation</a> <a href="/tags/NSOperationQueue/" style="font-size: 10px;">NSOperationQueue</a> <a href="/tags/SDK开发/" style="font-size: 10px;">SDK开发</a> <a href="/tags/Swift/" style="font-size: 15px;">Swift</a> <a href="/tags/UISearchbar/" style="font-size: 10px;">UISearchbar</a> <a href="/tags/cocospod/" style="font-size: 10px;">cocospod</a> <a href="/tags/dispatch-semaphore/" style="font-size: 10px;">dispatch_semaphore</a> <a href="/tags/framework/" style="font-size: 10px;">framework</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/runtime/" style="font-size: 10px;">runtime</a> <a href="/tags/target/" style="font-size: 10px;">target</a> <a href="/tags/多版本/" style="font-size: 10px;">多版本</a> <a href="/tags/对象、runtime/" style="font-size: 10px;">对象、runtime</a> <a href="/tags/对象模型/" style="font-size: 10px;">对象模型</a> <a href="/tags/开源框架/" style="font-size: 10px;">开源框架</a> <a href="/tags/总结/" style="font-size: 10px;">总结</a> <a href="/tags/消息转发/" style="font-size: 10px;">消息转发</a> <a href="/tags/源码/" style="font-size: 10px;">源码</a> <a href="/tags/第三方库/" style="font-size: 10px;">第三方库</a> <a href="/tags/视图架构、渲染/" style="font-size: 10px;">视图架构、渲染</a> <a href="/tags/适配/" style="font-size: 10px;">适配</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xiaoxuetu.github.io/">小学徒的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">小木头   iOS开发者</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">小木头</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7i7ht3.com1.z0.glb.clouddn.com/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">小木头</h1>
			</hgroup>
			
			<p class="header-subtitle">心中无敌则无敌于天下</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/about">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/lcddhr" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/329096966" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="http://lcddhr.github.io/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-iOS/29_GCD_Operation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/05/iOS/29_GCD_Operation/" class="article-date">
  	<time datetime="2016-01-05T11:39:17.000Z" itemprop="datePublished">2016-01-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      iOS翻译-你真的了解并发吗?
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GCD/">GCD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NSOperation/">NSOperation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/翻译/">翻译</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>翻译了一篇appcoda的文章，通俗易懂，理清了并发的相关知识点。</p>
<p>为了防止被墙，已把图片和demo下载的连接全部改成国内存储。</p>
<p>原文链接: <a href="http://www.appcoda.com/ios-concurrency/" target="_blank" rel="external">http://www.appcoda.com/ios-concurrency/</a></p>
<a id="more"></a>
<p><img src="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_1.jpg" alt="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_1.jpg"><br>并发一直被认为是iOS开发中的比较奇特的一部分。它被认为是危险的所以许多开发者尽可能避免使用。还有传言说尽可能避免使用多线程。如果你不能很好的理解多线程，多线程的确是危险的。猜想一下人们的生活中有多少危险的行为和活动，很多是吧？只有当我们掌握它，才能运用自如。并发是一个双刃剑，所以你必须掌握如何使用它。它帮助你写出高效、快速执行、响应迅速的app，但与此同时，如果误用则会毫不留情的毁坏你的app。这就是我们在写并发代码之前，首先考虑为什么需要并发，哪个API才能解决问题的原因。 在iOS里面我们有许多API可以使用，在这个教程里面，我们来谈谈最常用的 - <code>NSOperation</code> 和 <code>Dispatch Queues</code></p>
<h3 id="为什么需要并发？">为什么需要并发？</h3><p>我知道你是一个很棒的iOS开发者。无论你打算创造什么类型的app，你都需要知道并发能让你的app能够响应更迅速并且运行更快。这里总结了使用并发的几个优点</p>
<ul>
<li><p>利用iOS设备硬件：现在全部iOS设备有多核处理器允许开发者并发执行多个任务。你应该利用这个特性发挥硬件的优势。</p>
</li>
<li><p>更好的体验：你也许曾经写过web服务、处理一些IO,或者运行一些繁重的任务。做这类型的操作在UI线程将堵塞app的运行。用户面对这种情况，直接关闭app。并发在处理这些任务的时候可以在后台运行，不会阻塞主线程，不会让用户感觉的厌烦，他们仍然可以点击按钮，滑动app里面的视图，所有繁重的任务都在后台运行了。</p>
</li>
<li><p>NSOperation和dispatch queues的使用让并发更加简单：创建和管理线程并不是一件简单的任务。这就是为什么大部分开发者惧怕听到并发和多线程。在iOS里面，并发的API使用起来非常简单。你不必要关心线程的创建或者是底层的管理。API会帮你做这些事。另外一个重要的优点非常容易实现同步避免资源竞争。竞争发生在多线程访问共享资源，这样会导无法预料的结果。通过同步，你保证了线程间的资源的共享。</p>
</li>
</ul>
<h3 id="关于并发你需要知道什么?">关于并发你需要知道什么?</h3><p>这这个教程里，我们将向你解释需要了解的并发知识，减轻你的恐惧。首先我们推荐先了解一些<code>blocks</code>（Swift中的闭包）,因为并发的API里面大量的使用这些知识。然后我们将谈谈<code>dispatch queues</code>和<code>NSOperationQueues</code>,我们将引导你了解并发的知识点、不同点、如何去使用。</p>
<h3 id="Part_1:_GCD_(Grand_Central_Dispatch)">Part 1: GCD (Grand Central Dispatch)</h3><p>GCD 是最常用的API用来管理并发和执行异步操作在Unix底层系统中。GCD提供管理任务的队列。首先我们来看看队列(queue)是什么?</p>
<h3 id="什么是Queues">什么是Queues</h3><p>队列是一个数据结构，管理对象的先进先出(FIFO)。 队列非常像电影院售票窗口排队情况。 谁先来舍就能买到票。在计算机科学中，第一个添加进队列的对象也是第一个被移除的。<br><img src="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_2.jpg" alt="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_2.jpg"></p>
<h3 id="Dispatch_Queues">Dispatch Queues</h3><p><code>Dispatch queues</code>能够非常容易在你的应用中异步的并发执行任务。任务以<code>blocks</code>的形式提交到队列中。有两种类型的队列： </p>
<ul>
<li>(1) 串行队列(serial queues)</li>
<li>(2) 并发队列(concurrent queues)</li>
</ul>
<p>在谈他们之间的不同点时，你应该知道任务是不同线程中执行而不是单独的线程中处理。换句话说，你在主线程中创建的blocks提交了任务到dispatch queues.但是所有这些任务(Blocks of codes)将在不同的线程中执行。</p>
<h2 id="Serial_Queues">Serial Queues</h2><p>当你创建一个串行队列的时候，这个队列同一时间只能执行一个任务.所有在队列的任务都是平等的，按顺序执行。当然，你不必关心不同队列的任务，因为你仍然可以通过多个串行队列并发执行任务。举个例子：你可以创建两个串行队列，每个队列同一时刻执行一个任务，但是两个任务可以并发执行。</p>
<p>串行队列管理共享资源是非常有用的。他保证按顺序访问，防止竞争。想象一下只有售票口，但是一群人都想去买，所有的工作人员在这里是共享资源。如果工作人员不得不同时给人们提供服务，那么这将会变得没有秩序。为了解决这钟情况，需要要求人们排队(serial queue),所以工作人员才能同一时间为消费者提供服务。</p>
<p>另外一方面，这并不意味着电影院可以同一时间接纳一个消费者，假如它设定了多个售票口，他便可以为多个消费者服务。这就是我说的为什么使用多个串行队列任然可以执行多个任务。</p>
<p>使用串行队列的有点：</p>
<ul>
<li>1、保证访问的有序性，防止资源的竞争。</li>
<li>2、任务有序的执行。提交到串行队列的任务将按顺序执行</li>
<li>3、可以创建多个串行队列</li>
</ul>
<h2 id="Concurrent_Queues">Concurrent Queues</h2><p>顾名思义，并发队列允许并发的执行多个任务。每个任务(blocks of codes)按照他们添加到队列中的顺序启动。但是他们的执行是并发的，他们不必等其他任务开始。并发队列保证任务同一时间开始但不知道执行的顺序，执行时间、同一个时间点执行的任务数量。</p>
<p>举个列子，你提交了3个任务(#1, #2, #3)到一个并发队列.任务是并发执行的，启动的时候是按照添加到队列的顺序启动。然后，执行时间和完成时间是不一样的。有可能<code>#2</code>和<code>#3</code>开始花费了一些时间，也有可能在<code>#1</code> 任务完成前启动。 由系统来决定执行这些任务。</p>
<h2 id="使用Queues">使用Queues</h2><p>刚刚我们解释了串行和并发队列，现在我们来看看怎么使用它们。默认情况下，系统提供给我们一个串行队列和4个并发队列。</p>
<p><code>main dispatch queue</code>是全局的串行队列在主线程中执行。用来更新APP UI和运行UIView相关的更新。同一时间只有一个任务被执行，这就是当我们运行繁重的任务时会阻塞UI</p>
<p>除了主队列，系统还提供4个并发队列。我们称他们是<code>Global Dispatch queues</code>。这些队列是全局的，通过优先级来区分。使用这些全局的并发队列，你可以获得首选队列使用<code>dispatch_get_global_queue</code>,其中第一个参数可以有下面几个值：</p>
<ul>
<li>DISPATCH_QUEUE_PRIORITY_HIGH</li>
<li>DISPATCH_QUEUE_PRIORITY_DEFAULT</li>
<li>DISPATCH_QUEUE_PRIORITY_LOW</li>
<li>DISPATCH_QUEUE_PRIORITY_BACKGROUND</li>
</ul>
<p>这些队列类型代表着执行的优先级。<code>DISPATCH_QUEUE_PRIORITY_HIGH</code>优先级最高,<code>DISPATCH_QUEUE_PRIORITY_BACKGROUND</code>优先级最低。所以你可以基于任务的优先级来使用这些队列。请注意，Apple的API也在使用这些队列，所以你的任务并不是唯一的在这些队列中。</p>
<p>最后，你可以创建任意数量的串行和并行队列。尽管你可以自己创建并发队列，但我强烈建议使用这4个全局的并发队列。</p>
<h2 id="GCD_备忘录">GCD 备忘录</h2><p>现在，你已经基本了解了 <code>dispatch queues</code>，我打算给你一个简单的备忘录，这个图非常简单，包含了所有你需要知道的GCD知识点。<br><img src="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_3.png" alt="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_3.png"></p>
<p>很棒是吧？现在让我们来写一个demo来看看如何使用dispatch queues。我讲向你展示如何利用dispatch queues完善app的展示，让它更快的响应。</p>
<h2 id="Demo_Project">Demo Project</h2><p>这个demo非常简单，展示4张图片,每一个需要请求网络。这个图片在主线程请求。为了展示给你UI是如何响应的，我添加了一个slider在image下面。<a href="http://7i7ht3.com1.z0.glb.clouddn.com/ConcurrencyDemoStarter.zip" target="_blank" rel="external">下载Demo</a></p>
<p>点击start按钮下载图片,与此同时拖动slider在下载期间，你会发现你不能拖动他。</p>
<p><img src="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_4.png" alt="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_4.png"></p>
<p>当你点击开始按钮，图片开始被加载在主线程。很明显，这个方法非常糟糕，让UI没有反应。不幸的是现在还有好多APP在加载这样的任务的时候还放在主线程。现在我们用dispatch queues修改它。</p>
<p>首先我们将使用并发队列然后再使用串行队列</p>
<h2 id="使用并发队列">使用并发队列</h2><p>打开<code>ViewController.swift</code>，在<code>didClickOnStart</code>方法是处理图片的下载。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@IBAction</span> <span class="func"><span class="keyword">func</span> <span class="title">didClickOnStart</span><span class="params">(sender: AnyObject)</span></span> &#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> img1 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">self</span>.imageView1.image = img1</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> img2 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">self</span>.imageView2.image = img2</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> img3 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">self</span>.imageView3.image = img3</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> img4 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">3</span>])</span><br><span class="line"><span class="keyword">self</span>.imageView4.image = img4</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个<code>downloader</code>被认为是一个任务，所有任务都在主线程执行。现在，让我们获得一个全局并发队列的引用，这个优先级的Default</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>)</span><br><span class="line">       dispatch_async<span class="function"><span class="params">(queue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">           </span><br><span class="line">           <span class="keyword">let</span> img1 = Downloader.downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line">           dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">               </span><br><span class="line">               self.imageView1.image = img1</span><br><span class="line">           &#125;)</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>我们在block里面提交了一个任务下载第一张图片.当图片下载完成，我们提交另一个任务给主线程，使用这个下载好的image更新视图. 换句话说，我们把这些任务放到后台线程下载，然后在主线程执行UI相关的操作.<code>didClickOnStart</code>修改后的代码:</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">	<span class="property">@IBAction</span> func didClickOnStart(<span class="attribute">sender</span>: AnyObject) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>)</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(queue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img1 = Downloader.downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView1.image = img1</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(queue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img2 = Downloader.downloadImageWithURL(imageURLs[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView2.image = img2</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(queue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img3 = Downloader.downloadImageWithURL(imageURLs[<span class="number">2</span>])</span><br><span class="line">        </span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView3.image = img3</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(queue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img4 = Downloader.downloadImageWithURL(imageURLs[<span class="number">3</span>])</span><br><span class="line">        </span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView4.image = img4</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你刚刚提交了4个并发下载图片的任务在<code>default queue</code>。现在运行app，它将快速的响应，并且下载的过程中还能够拖动slider</p>
<h2 id="使用串行队列">使用串行队列</h2><p>另外一种解决的办法是使用串行队列。回到刚刚的<code>didClickOnStart()</code>方法，现在我们将使用串行队列来下载图片. 当我们使用串行队列的时候，我们应该注意引用了那一条队列。每个app有一个默认的串行队列（就是main queue）。 所以，我们在使用串行队列的时候，必须创建一个新的队列，否则任务可能在更新UI的时候执行，这会带来很糟糕的用户体验。你可以使用<code>dispatch_queue_create</code>来创建一个新的队列,修改后的代码是这样的：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="property">@IBAction</span> func didClickOnStart(<span class="attribute">sender</span>: AnyObject) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> serialQueue = dispatch_queue_create(<span class="string">"com.appcoda.imagesQueue"</span>, DISPATCH_QUEUE_SERIAL)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    dispatch_async<span class="function"><span class="params">(serialQueue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img1 = Downloader .downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView1.image = img1</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(serialQueue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img2 = Downloader.downloadImageWithURL(imageURLs[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView2.image = img2</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(serialQueue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img3 = Downloader.downloadImageWithURL(imageURLs[<span class="number">2</span>])</span><br><span class="line">        </span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView3.image = img3</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async<span class="function"><span class="params">(serialQueue)</span> &#123; <span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img4 = Downloader.downloadImageWithURL(imageURLs[<span class="number">3</span>])</span><br><span class="line">        </span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">            </span><br><span class="line">            self.imageView4.image = img4</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的两个点:</p>
<ul>
<li>1、比起并发队列下载,串行队列花费长一点的时间下载图片。原因是因为我们同一时间只下载一张图片。每一个任务需要等待先前的任务完成，然后再执行</li>
<li>2、image是按顺序加载的,image1,image2,image3,image4。这是因为串行队列在同一时间只能执行一个任务</li>
</ul>
<h2 id="Part_2:_Operation_Queues">Part 2: Operation Queues</h2><p>GCD的底层是基于C来实现并发的。<code>Operation queues</code>，是基于GCD的抽象。这意味着可以像GCD一样执行任务，但是有面向对象的风格。总之，Operation queues让开发者使用起来更简单。</p>
<p>不像<code>GCD</code>，<code>Operation queues</code>不遵循先进先出顺序。<code>Operation queues</code>和<code>dispatch queues</code>的不同点是：</p>
<ul>
<li><p>1、不遵从FIFO(先进先出): 在<code>Operation queues</code>可以设置operation的优先级、添加operation间的依赖，这意味着可以定义operation的执行顺序，某些operation必须在其他opeartion完成之后执行。这就没有遵从先进先出的概念.</p>
</li>
<li><p>2、默认的，operation是并发的： 不能改变成串行类型。但是能够通过设置operation之间的依赖关系来实现串行的功能。</p>
</li>
<li><p>3、Operation Queues是<code>NSOperationQueue</code>的实例，任务封装在<code>NSOperation</code>实例当中</p>
</li>
</ul>
<h2 id="NSOperation">NSOperation</h2><p>提交到Operation Queues的任务都是<code>NSOperation</code>实例。 我们在GCD中讨论过任务提交的形式都是通过block。 这里也可以这样做，只不过打包在<code>NSOperation</code>中. 你可以简单的认为<code>NSOperation</code>是工作的一个单元。</p>
<p><code>NSOperation</code>是一个抽象的class，不能直接使用，所以我们不得不使用使用它的子类.在iOS中提供了两个现有的<code>NSOperation</code>的子类，这些类可以直接使用，但你任然可以使用自己的<code>NSOperation</code>子类运行这些操作，这两个类是:</p>
<ul>
<li><p>1、NSBlockOperation：使用这个类用block形式初始化operation. 这个operation自己可以包含多个block，当所有block执行完毕，这个operation则被认为是完成</p>
</li>
<li><p>2、NSInvocationOperation： 用invok一个selector的方式初始化一个operation</p>
</li>
</ul>
<p>那么，NSOperation的有点是什么？</p>
<ul>
<li><p>1、首先，他们支持依赖关系，通过使用<code>addDependency</code>方法.当你需要开始一个operation依赖于另外一个operation执行完成时候，会使用NSOperation。<br><img src="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_5.png" alt="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_5.png"></p>
</li>
<li><p>2、可以改变执行的优先级,设置<code>queuePriority</code>属性为下面的值，高优先级的会先执行。</p>
</li>
</ul>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">enum</span> <span class="title">NSOperationQueuePriority</span> : <span class="title">Int</span> &#123;</span></span><br><span class="line">   <span class="keyword">case</span> <span class="constant">VeryLow</span></span><br><span class="line">   <span class="keyword">case</span> <span class="constant">Low</span></span><br><span class="line">   <span class="keyword">case</span> <span class="constant">Normal</span></span><br><span class="line">   <span class="keyword">case</span> <span class="constant">High</span></span><br><span class="line">   <span class="keyword">case</span> <span class="constant">VeryHigh</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>3、可以取消特定的operation或者所有operation.operation添加到queue之后可以被取消，<code>cancel()</code>方法被调用的时候取消已经完成。 当你取消任意一个operation，下面三个当中场景的其中一个会发生：</p>
<ul>
<li>operation已经完成。这种情况cancel方法什么都不做。</li>
<li>operation正在执行.这种情况，系统不会强制停止operation，但会吧<code>cancelled</code>属性置为true</li>
<li>operation任然在等待执行。这种情况，operation将永远不会被执行。</li>
</ul>
</li>
<li><p>4、NSOperation有3个有用的bool属性<code>finished</code>、<code>cancelled</code>、<code>ready</code>. </p>
<ul>
<li>finished 在执行完成后设置为true</li>
<li>cancelled 在operation被调用<code>cancel()</code>方法后设置为true</li>
<li>ready 在operation即将执行的时候设置true</li>
</ul>
</li>
<li>5、任何一个<code>NSOperation</code>有一个完成后被调用的block，这个block将被调用，当finished设置为true的时候</li>
</ul>
<p>现在让我们用NSOperationQueues重写刚刚那个的demo。首先声明属性，在ViewController里面:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">var</span> queue = <span class="function"><span class="title">NSOperationQueue</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>在<code>didClickOnstart()</code>方法里面修改代码：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">	<span class="property">@IBAction</span> func didClickOnStart(<span class="attribute">sender</span>: AnyObject) &#123;</span><br><span class="line">    queue = NSOperationQueue()</span><br><span class="line"> </span><br><span class="line">    queue.addOperationWithBlock &#123; <span class="function"><span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> img1 = Downloader.downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line"> </span><br><span class="line">        NSOperationQueue.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            self.imageView1.image = img1</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    queue.addOperationWithBlock &#123; <span class="function"><span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> img2 = Downloader.downloadImageWithURL(imageURLs[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        NSOperationQueue.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            self.imageView2.image = img2</span><br><span class="line">        &#125;)</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    queue.addOperationWithBlock &#123; <span class="function"><span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> img3 = Downloader.downloadImageWithURL(imageURLs[<span class="number">2</span>])</span><br><span class="line">        </span><br><span class="line">        NSOperationQueue.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            self.imageView3.image = img3</span><br><span class="line">        &#125;)</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    queue.addOperationWithBlock &#123; <span class="function"><span class="params">()</span> -&gt;</span> Void <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> img4 = Downloader.downloadImageWithURL(imageURLs[<span class="number">3</span>])</span><br><span class="line">        </span><br><span class="line">        NSOperationQueue.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            self.imageView4.image = img4</span><br><span class="line">        &#125;)</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>addOperationWithBlock</code>创建了一个operation，很简单是不？为了在主线程执行，替代了使用GCD中调用的<code>dispatch_async()</code> ,我们可以用<code>NSOperationQueue.mainQueue()</code>实现相同的功能。</p>
<p>上面的例子使用<code>addOperationWithBlock</code>来添加operation在queue。让我们来看看<code>NSBlockOperation</code>是如何实现的</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@IBAction</span> <span class="func"><span class="keyword">func</span> <span class="title">didClickOnStart</span><span class="params">(sender: AnyObject)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    queue = <span class="type">NSOperationQueue</span>()</span><br><span class="line">    <span class="keyword">let</span> operation1 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">        <span class="keyword">let</span> img1 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line">        <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            <span class="keyword">self</span>.imageView1.image = img1</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    operation1.completionBlock = &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Operation 1 completed"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    queue.addOperation(operation1)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> operation2 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">        <span class="keyword">let</span> img2 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">1</span>])</span><br><span class="line">        <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            <span class="keyword">self</span>.imageView2.image = img2</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    operation2.completionBlock = &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Operation 2 completed"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    queue.addOperation(operation2)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> operation3 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">        <span class="keyword">let</span> img3 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">2</span>])</span><br><span class="line">        <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            <span class="keyword">self</span>.imageView3.image = img3</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    operation3.completionBlock = &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Operation 3 completed"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    queue.addOperation(operation3)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> operation4 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">        <span class="keyword">let</span> img4 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">3</span>])</span><br><span class="line">        <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">            <span class="keyword">self</span>.imageView4.image = img4</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    operation4.completionBlock = &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Operation 4 completed"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    queue.addOperation(operation4)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建了一个<code>NSBlockOperation</code>实例把任务封装到block。 使用<code>NSBlockOperation</code>，允许设置完成的回调(completion handler). Operation完成后，回调会被调用。运行demo后，控制台上输出:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Operation <span class="number">1</span> completed</span><br><span class="line">Operation <span class="number">3</span> completed</span><br><span class="line">Operation <span class="number">2</span> completed</span><br><span class="line">Operation <span class="number">4</span> completed</span><br></pre></td></tr></table></figure>
<h2 id="取消Operations">取消Operations</h2><p>如上面提到的，<code>NSBlockOperation</code>允许我们管理operations。现在我们创建一个cancel按钮放到导航栏,实现cancel这个事件。 为了说明cancel operation,添加依赖在<code>#2</code>和<code>#1</code>之间, 然后在添加<code>#3</code>和<code>#2</code>之间的依赖。 这就说明<code>#2</code>会在<code>#1</code>完成时候开始，<code>#3</code>会在<code>#2</code>完成后开始。 <code>#4</code>没有依赖会并发工作。</p>
<p>取消所有operation的方法是<code>cancelAllOperations()</code>,在ViewController类里面添加。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@IBAction</span> <span class="func"><span class="keyword">func</span> <span class="title">didClickOnCancel</span><span class="params">(sender: AnyObject)</span></span> &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">self</span>.queue.cancelAllOperations()</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>修改后的<code>didClickOnStart()</code>代码是</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@IBAction</span> <span class="func"><span class="keyword">func</span> <span class="title">didClickOnStart</span><span class="params">(sender: AnyObject)</span></span> &#123;</span><br><span class="line">      queue = <span class="type">NSOperationQueue</span>()</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> operation1 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">          <span class="keyword">let</span> img1 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">0</span>])</span><br><span class="line">          <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">              <span class="keyword">self</span>.imageView1.image = img1</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      </span><br><span class="line">      operation1.completionBlock = &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">"Operation 1 completed, cancelled:<span class="subst">\(operation1.cancelled)</span>"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      queue.addOperation(operation1)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> operation2 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">          <span class="keyword">let</span> img2 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">1</span>])</span><br><span class="line">          <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">              <span class="keyword">self</span>.imageView2.image = img2</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      operation2.addDependency(operation1)</span><br><span class="line">      operation2.completionBlock = &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">"Operation 2 completed, cancelled:<span class="subst">\(operation2.cancelled)</span>"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      queue.addOperation(operation2)</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> operation3 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">          <span class="keyword">let</span> img3 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">2</span>])</span><br><span class="line">          <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">              <span class="keyword">self</span>.imageView3.image = img3</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      operation3.addDependency(operation2)</span><br><span class="line"></span><br><span class="line">      operation3.completionBlock = &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">"Operation 3 completed, cancelled:<span class="subst">\(operation3.cancelled)</span>"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      queue.addOperation(operation3)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> operation4 = <span class="type">NSBlockOperation</span>(block: &#123;</span><br><span class="line">          <span class="keyword">let</span> img4 = <span class="type">Downloader</span>.downloadImageWithURL(imageURLs[<span class="number">3</span>])</span><br><span class="line">          <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</span><br><span class="line">              <span class="keyword">self</span>.imageView4.image = img4</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      </span><br><span class="line">      operation4.completionBlock = &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">"Operation 4 completed, cancelled:<span class="subst">\(operation4.cancelled)</span>"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      queue.addOperation(operation4)</span><br><span class="line">      </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>执行的结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Operation <span class="number">3</span> completed, cancelled:<span class="literal">true</span></span><br><span class="line">Operation <span class="number">2</span> completed, cancelled:<span class="literal">true</span></span><br><span class="line">Operation <span class="number">1</span> completed, cancelled:<span class="literal">true</span></span><br><span class="line">Operation <span class="number">4</span> completed, cancelled:<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>按下start按钮后点击取消按钮. 这些operation将被取消在operation <code>#1</code>完成之后。</p>
<p>在这里发生了什么？</p>
<ul>
<li><p>1、当<code>#1</code>已经执行，cancel不执行任何事情。第一张图片任然显示</p>
</li>
<li><p>2、点击cancel按钮足够快，<code>#2</code>被取消. <code>cancelAllOperations()</code>阻止<code>#2</code>执行，所以image2没有显示</p>
</li>
<li><p>3、<code>#3</code>依赖<code>#2</code>完成，因为<code>#2</code>取消了，所以<code>#2</code>也不能被执行</p>
</li>
<li><p>4、<code>#4</code>没有依赖，并发执行，所以下载了图片.</p>
</li>
</ul>
<p><img src="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_6.png" alt="http://7i7ht3.com1.z0.glb.clouddn.com/29_GCD_NSOperation_6.png"></p>
<h2 id="总结">总结</h2><p>1、了解并发的概念、解释了GCD、创建串行和并发队列</p>
<p>2、检验了NSOperationQueues的执行顺序</p>
<p>3、学习了NSOperationQueues和GCD的优缺点</p>
<h2 id="参考">参考</h2><p>完整的<a href="https://github.com/appcoda/NSOperation-Demo" target="_blank" rel="external">Demo</a></p>
<p>深入了解: <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html" target="_blank" rel="external">https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/01/06/iOS/30_SearchBar/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          iOS翻译-如何自定义SearchBar
        
      </div>
    </a>
  
  
    <a href="/2016/01/04/iOS/28_Runloop/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">iOS-RunLoop</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="iOS/29_GCD_Operation" data-title="iOS翻译-你真的了解并发吗?" data-url="http://www.liuchendi.com/2016/01/05/iOS/29_GCD_Operation/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"liuchendi"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 小木头
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256997755'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256997755%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
>

</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>